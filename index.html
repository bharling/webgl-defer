<html>

<head>
<title>Learning WebGL &mdash; lesson 1</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="js/glMatrix.min.js"></script>


<style type="text/css">
	body, html {
		margin:0;
	}
	

	
	
</style>

<script type="text/javascript">

    var gl, deriv_ext, half_ext;
    function initGL(canvas) {
        try {
            gl = canvas.getContext("webgl");
            gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
            
            deriv_ext = gl.getExtension('OES_standard_derivatives');
            half_ext = gl.getExtension('OES_texture_half_float');
            
            
        } catch (e) {
        }
        if (!gl) {
            alert("Could not initialise WebGL, sorry :-(");
        }
    }


    var shaderProgram;


    var mvMatrix = mat4.create();
    var pMatrix = mat4.create();
    var mvMatrixStack = [];
   	var sunLight;

   	
    
    function mvPushMatrix() {
    	var copy = mat4.create();
    	mat4.set(mvMatrix, copy);
    	mvMatrixStack.push(copy);
    }
    
    function mvPopMatrix() {
    	if (mvMatrixStack.length == 0) {
    		throw "Invalid PopMatrix!";
    	}
    	mvMatrix = mvMatrixStack.pop();
    }





    var triangleVertexPositionBuffer;
    var triangleVertexColorBuffer;
    var squareVertexPositionBuffer;
    var squareVertexColorBuffer;



	function degToRad(degrees) {
		return degrees * Math.PI / 180;
	}

	
	var rTri = 0;
	var rSquare = 0;
	
	var DEBUG_VIEW = 0;
	
	
	function defaultRenderSettings () {
		gl.clearColor( 0.0, 0.0, 0.0, 0.0);
		gl.enable(gl.DEPTH_TEST);
		gl.depthFunc(gl.LEQUAL);
		gl.depthMask(true);
		gl.clearDepth(1.0);
		gl.enable(gl.BLEND);
		gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
		gl.enable(gl.CULL_FACE);
	}
	
	
		
    function drawScene() {
    	
    	gbuffer.bind();
    	
    	
    	gl.cullFace ( gl.BACK ) ;
    	gl.blendFunc( gl.ONE, gl.ZERO );
    	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT );
    	gl.enable(gl.CULL_FACE);
    	
        var angle = degToRad(rTri);
        var radius = 100.0;
        
        
        //camera.setPosition([ radius * Math.sin(angle), 27.0 * Math.sin(angle*0.5), radius * Math.cos(angle) ]);

        sunLight.setPosition([ radius * Math.sin(angle), 27.0, radius * Math.cos(angle) ]);

        camera.updateViewMatrix();
        //camera.updateProjectionMatrix();
        
        var viewMatrix = camera.getViewMatrix();
        
        var projectionMatrix = camera.getProjectionMatrix();
        
        for ( var i=0; i < pots.length; i ++ ) {
        	var pot = pots[i];
        	
        	if (pot.bind()) { 
        		pot.material.use();
	        	var worldMatrix = pot.getWorldTransform();
	        	var worldViewMatrix = mat4.create(), normalMatrix = mat3.create();
	        	mat4.multiply( viewMatrix, worldMatrix, worldViewMatrix );
	        	
	        	mat4.toInverseMat3(worldMatrix, normalMatrix);
	        	mat3.transpose(normalMatrix);
	        	
	        	pot.setMatrixUniforms(worldViewMatrix, camera.getProjectionMatrix());
	        	
	        	gl.uniformMatrix3fv(pot.material.getUniform('uNormalMatrix'), false, normalMatrix);
        		gl.uniformMatrix4fv(pot.material.getUniform('uViewMatrix'), false, viewMatrix);
        	
        		pot.setFloatUniform('farClip', camera.far);
        	
        	
	        	// bind textures
	        	gl.activeTexture(gl.TEXTURE0);
	        	gl.bindTexture(gl.TEXTURE_2D, pot.material.diffuseMap);
	        	gl.uniform1i(pot.material.getUniform('diffuseTex'), 0);
	        	
	        	
	        	gl.activeTexture(gl.TEXTURE1);
	        	gl.bindTexture(gl.TEXTURE_2D, pot.material.normalMap);
	        	gl.uniform1i(pot.material.getUniform('normalTex'), 1);
        	
        	
        		pot.draw();
        		pot.release();
        	
        	}
        }
        
        
        gbuffer.release();
        
        if (quad) {
        	quad.material.use();
	        quad.bind();
	        
	        gl.activeTexture(gl.TEXTURE0);
	        gl.bindTexture(gl.TEXTURE_2D, gbuffer.getDepthTextureUnit());
	        
	        gl.activeTexture(gl.TEXTURE1);
	        gl.bindTexture(gl.TEXTURE_2D, gbuffer.getNormalsTextureUnit());
	        
	        gl.activeTexture(gl.TEXTURE2);
	        gl.bindTexture(gl.TEXTURE_2D, gbuffer.getAlbedoTextureUnit());
	        
	        gl.uniform1i(quad.material.getUniform('depthTexture'), 0);
	        gl.uniform1i(quad.material.getUniform('normalsTexture'), 1);
	        gl.uniform1i(quad.material.getUniform('albedoTexture'), 2);

	        gl.uniform3fv(quad.material.getUniform('lightPosition'), sunLight.position);

	        //console.log(sunLight.position)

	        //sunLight.bind(quad.material.uniforms);
	        
	        gl.uniformMatrix4fv(quad.material.getUniform('inverseProjectionMatrix'), false, camera.getInverseProjectionMatrix());
	        
	        //gl.uniform4f(quad.material.getUniform('projectionParams'), projectionParams[0], projectionParams[1], projectionParams[2], projectionParams[3] );
	        
	        gl.uniform1i(quad.material.getUniform('DEBUG'), DEBUG_VIEW);
	        
	        gl.drawArrays(gl.TRIANGLES, 0, quad.vertexBuffer.numItems);
	        
	        quad.release();
        }
        
        
        
        //gl.disable( gl.CULL_FACE );
        if (debug_material) {
        	debug_material.use();
        
	        gl.activeTexture(gl.TEXTURE0);
	        gl.bindTexture(gl.TEXTURE_2D, gbuffer.getDepthTextureUnit());
	        
	        gl.activeTexture(gl.TEXTURE1);
	        gl.bindTexture(gl.TEXTURE_2D, gbuffer.getNormalsTextureUnit());
	        
	        gl.activeTexture(gl.TEXTURE2);
	        gl.bindTexture(gl.TEXTURE_2D, gbuffer.getAlbedoTextureUnit());
	        
	        gl.uniform1i(debug_material.getUniform('depthTexture'), 0);
	        gl.uniform1i(debug_material.getUniform('normalsTexture'), 1);
	        gl.uniform1i(debug_material.getUniform('albedoTexture'), 2);
	        
	        gl.uniformMatrix4fv(debug_material.getUniform('inverseProjectionMatrix'), false, camera.getInverseProjectionMatrix());
	        
	        //gl.uniform4f(debug_material.getUniform('projectionParams'), projectionParams[0], projectionParams[1], projectionParams[2], projectionParams[3] );
	        
	        debug_grid.bind(debug_material);
	        debug_grid.draw();
	        debug_grid.release();
        }
        
    }
	
	var lastTime = 0;
	function animate() {
		var now = new Date().getTime();
		if (lastTime != 0) {
			elapsed = now - lastTime;
			
			rTri += (90*elapsed) / 1000.0;
			rSquare += (75*elapsed) / 1000.0;
		}
		
		lastTime = now;
	}

	
	function tick () {
		requestAnimationFrame(tick);
		drawScene();
		animate();
	}

	var teapot, quad, camera, debug_grid, debug_material;
	var pots = [];
	
	var pots_per_side = 5;
	var pots_half = 30.0 * pots_per_side / 2;

	function loadModel () {
		
		DFIR.ShaderLoader.load('shaders/gbuffer_vert.glsl', 'shaders/gbuffer_frag.glsl', function (program) {
			var mat = new DFIR.Shader( program );
			
			for ( var x = 0; x < pots_per_side; x++ )  {
				for (var y =0; y < pots_per_side; y++) { 
				   pot = new DFIR.JSONGeometry('models/teapot.json');
				   pot.setMaterial(mat);
				   pot.material.setDiffuseMap('textures/diffuse.jpg');
				   pot.material.setNormalMap('textures/normals.png');
				   pot.setPosition([-pots_half + (x * 30.0), 0.0, -pots_half + (y * 25.0) ]);
				   
				   //pot.setScale([0.5,0.5,0.5]);
				   pots.push(pot);
				}
			}
		});
		
		DFIR.ShaderLoader.load( 'shaders/fs_quad_vert.glsl', 'shaders/fs_quad_frag.glsl', function (program) {
			quad = new DFIR.FullscreenQuad();
			quad.setMaterial ( new DFIR.Shader ( program ));
			quad.material.showInfo();
		});
		
		
		DFIR.ShaderLoader.load('shaders/debug_grid_vert.glsl', 'shaders/fs_quad_frag.glsl', function (program) {
			debug_grid = new DFIR.DebugGridView(6);
			debug_material = new DFIR.Shader ( program );
		});
		
		camera = new DFIR.Camera(gbuffer.width, gbuffer.height);
		camera.setPosition([ 0.0, 40.0, -200.0 ]);
		camera.setNearClip(1.0);
		camera.setFarClip(500.0);
		sunLight = new DFIR.DirectionalLight(vec3.create(0.0, 1.0, 0.5));

		
	}

	
	var gbuffer;
	
    function webGLStart() {
        var canvas = document.getElementById("canvas");
        initGL(canvas);
        
        gbuffer = new DFIR.Gbuffer(1.0);
        
        
        //initShaders();
        
        loadModel();

        defaultRenderSettings();
        
        tick();
    }

	function onSelectChange(value) {
		DEBUG_VIEW = value;
	}


</script>


</head>


<body onload="webGLStart();">

    <canvas id="canvas" style="border: none;" width="800" height="600"></canvas>


	<select id="debug_view" style="position:absolute;top:10px;left:10px;" onchange="onSelectChange(this.value);">
		<option value="0">Full Render</option>
		<option value="1">Compressed Depth ( Alpha amplified )</option>
		<option value="2">Compressed Normal</option>
		<option value="3">Albedo</option>
		<option value="4">Decoded Depth Buffer</option>
		<option value="5">Decoded Normals</option>
		<option value="6">Decoded View Position (x 10)</option>
	</select>
    
    
    <!-- build:remove:dist -->
    <script src="//localhost:35729/livereload.js"></script>
    <!-- /build -->
    
    <script type="text/javascript" src="js/main.js"></script>
    
    
</body>

</html>
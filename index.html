<html>

<head>
<title>DFIR Engine - Demo</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="js/glMatrix.min.js"></script>
<script type="text/javascript" src="js/md5.js"></script>


<style type="text/css">
	body, html {
		margin:0;
	}

	canvas {
		width:100%;
		height:100%;
	}
</style>

<script type="text/javascript">

	var scene, renderer, camera, canvas, potsRoot, torusRoot, material, lastTime = 0, elapsed = 0;

	function webGLStart() {
		canvas = document.getElementById("canvas");

		try {
        	//canvas.width = 1280;
        	//canvas.height = 720;
            gl = canvas.getContext("webgl");
            gl.viewportWidth = canvas.clientWidth;
            gl.viewportHeight = canvas.clientHeight;

            deriv_ext = gl.getExtension('OES_standard_derivatives');
            half_ext = gl.getExtension('OES_texture_half_float');
        } catch (e) {
        }
        if (!gl) {
            alert("Could not initialise WebGL, sorry :-(");
        }

		scene = new DFIR.Scene();
		renderer = new DFIR.Renderer(canvas);
		camera = new DFIR.FPSCamera(gl.drawingBufferWidth, gl.drawingBufferHeight, canvas)
		camera.setPosition(vec3.fromValues( 0.0, -40.0, -100.0 ));
		camera.setNearClip(1.0);
		camera.setFarClip(100000.0);

		var numPots = 4;
		var spacing = 37;
		var size = numPots * spacing;
		var tl = -(size / 2) + (spacing/2);
		console.log (tl);

		torusRoot = new DFIR.SceneNode();
		potsRoot = new DFIR.SceneNode();

		DFIR.ShaderLoader.load('shaders/gbuffer_vert.glsl', 'shaders/gbuffer_frag.glsl', function (program) {
			material = new DFIR.PBRShader( program );

			material.setDiffuseMap('textures/diffuse.jpg');
			material.setNormalMap('textures/NMStripes.png');
			//material.normalMapLoaded = true;
			material.showInfo();

			material.roughness = 0.0;
			material.metallic = 0.6;


			torusRoot.setParent(scene.root);
			potsRoot.setParent(scene.root);
			//scene.root.addChild(potsRoot);

			var node;

			for ( var x = 0; x < numPots; x++ )  {
				for (var y = 0; y < numPots; y++) {
				   t = new DFIR.JSONGeometry('models/torus.json');
				   t.setMaterial(material);
				   node = new DFIR.SceneNode()
				   node.attach(t);
				   node.translate( vec3.fromValues( tl + (spacing*x), 0.0, tl + (spacing*y) ));
				   node.scale(6.0);
				   node.setParent(torusRoot);

				   p = new DFIR.JSONGeometry('models/teapot.json');
				   p.setMaterial(material);
				   node = new DFIR.SceneNode()
				   node.attach(p);
				   node.translate( vec3.fromValues( tl + (spacing*x), 0.0, tl + (spacing*y) ));
				   node.setParent(potsRoot);
				   //pots.push(node);
				}
			}

			torusRoot.visible = false;


		});
		//window.onSceneSelect("0");
		tick()
	}

	function tick () {
		requestAnimationFrame(tick);
		var now = performance.now();
		if (lastTime != 0) {
			elapsed = now - lastTime;
		}
		lastTime = now;
		updateScene( elapsed );
		drawScene();
		document.getElementById('drawCalls').innerHTML = renderer.drawCallCount;

	}

	function updateScene(timeSinceLastFrame) {
		camera.update();
		scene.root.rotateY(0.0005 * timeSinceLastFrame);
	}

	function drawScene() {
		renderer.draw(scene, camera);
	}

	function onSelectChange(value) {
		renderer.debug_view = value;
	}

   	function onSceneSelect(value) {
   		potsRoot.visible = (value == "0");
   		torusRoot.visible = (value == "1");
   	}

		function updateMetallic (value) {

			material.metallic = parseFloat(value);
		}

		function updateRoughness (value) {
			material.roughness = parseFloat(value);
		}

		function updateExposure( value ) {
			renderer.exposure = value;
		}
</script>


<style type="text/css" media="screen">
	#drawCalls {
		font-size: 2rem;
		font-family: Lucida sans-serif;
		position: absolute;
		top: 10px;
		right: 10px;
		color:red;
	}

	label {
		display: block;

	}

	input, select {
		display: block;
		margin:3px 0px;
	}

	#controls {
		background:white;
		padding:4px;
	}
</style>

</head>


<body onload="webGLStart();">

    <canvas id="canvas" style="border: none;" width="800" height="600"></canvas>

	<div id="controls" style="position:absolute;top:10px;left:10px;">
	<select id="debug_view"  onchange="onSelectChange(this.value);">
		<option value="0">Full Render</option>
		<option value="1">Compressed Depth ( Alpha amplified )</option>
		<option value="2">Compressed Normal</option>
		<option value="3">Albedo</option>
		<option value="4">Decoded Depth Buffer</option>
		<option value="5">Decoded Normals</option>
		<option value="6">Decoded View Position (x 10)</option>
	</select>

	<select name="scene" onchange="onSceneSelect(this.value);">
		<option value="0">Teapots</option>
		<option value="1">Torii</option>
	</select>

	<label>Metallic</label>
	<input type="range" id="metallic" min="0.0" max="1.0" step="0.001" onchange="updateMetallic(this.value);" oninput="updateMetallic(this.value);">

	<label>roughness</label>
	<input type="range" id="roughness" min="0.0" max="1.0" step="0.001" onchange="updateRoughness(this.value);" oninput="updateRoughness(this.value);">

<label>Exposure</label>
<input type="range" id="exposure" min="0.0" max="40.0" step="0.001" onchange="updateExposure(this.value);" oninput="updateExposure(this.value);">
</div>

	<p id="drawCalls">
	0
	</p>


    <!-- build:remove:dist -->
    <script src="//localhost:35729/livereload.js"></script>
    <!-- /build -->

    <script type="text/javascript" src="js/main.js"></script>


</body>

</html>

/*
 * @fileoverview DFIR Engine - Deferred WebGL render engine
 * @author Ben Harling
 * @version 0.7
 *

Copyright (c) 2016, Ben Harling

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 */
(function(){var a,b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=function(a,b){function c(){this.constructor=a}for(var d in b)A.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},A={}.hasOwnProperty,B=function(a,b){return function(){return a.apply(b,arguments)}},C=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};j="undefined"!=typeof j?j:window,a={},a.currentId=0,a.nextId=function(){return a.currentId++},j.DFIR=a,mat3.makeTranslation=function(a,b){var c;return c=mat3.create(),mat3.identity(c),c[6]=a,c[7]=b,c},mat3.makeRotation=function(a){var b,c,d;return b=Math.cos(a),d=Math.sin(a),c=mat3.create(),c.identity(),c[0]=b,c[1]=-d,c[2]=0,c[3]=d,c[4]=b,c[5]=0,c[6]=0,c[7]=0,c[8]=1,c},mat3.makeProjection=function(a,b){var c;return c=mat3.create(),mat3.identity(c),c[0]=2/a,c[1]=0,c[2]=0,c[3]=0,c[4]=-2/b,c[5]=0,c[6]=-1,c[7]=1,c[8]=1,c},mat3.makeScale=function(a,b){var c;return c=mat3.create(),mat3.identity(c),c[0]=a,c[4]=b,c},mat3.multiply=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;return c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=b[0],m=b[1],n=b[2],o=b[3],p=b[4],q=b[5],r=b[6],s=b[7],t=b[8],u=mat3.create(),u[0]=c*l+d*o+e*r,u[1]=c*m+d*p+e*s,u[2]=c*n+d*q+e*t,u[3]=f*l+g*o+h*r,u[4]=f*m+g*p+h*s,u[5]=f*n+g*q+h*t,u[6]=i*l+j*o+k*r,u[7]=i*m+j*p+k*s,u[8]=i*n+j*q+k*t,u},w=function(a){var b,c;return b=a[0]/gl.viewportWidth,c=a[1]/gl.viewportHeight,b=2*b,c=2*c,b-=1,c-=1,c*=-1,[b,c]},a.Buffer=function(){function a(a,b,c,d){this.itemSize=b,null==d&&(d=gl.ARRAY_BUFFER),this.buffer=gl.createBuffer(),gl.bindBuffer(d,this.buffer),gl.bufferData(d,a,c),this.numItems=a.length/this.itemSize}return a.prototype.bind=function(){return gl.bindBuffer(this.buffer)},a.prototype.get=function(){return this.buffer},a.prototype.release=function(){return gl.bindBuffer(null)},a}(),a.Object2D=function(){function a(){}return a}(),a.Object3D=function(){function a(){this.position=vec3.create(),this.scale=vec3.fromValues(1,1,1),this.rotation=quat.create(),this.transform=mat4.create(),this.transformDirty=!0,this.normalMatrix=mat3.create(),this.children=[],this.visible=!0}return a.prototype.getWorldTransform=function(){return this.transformDirty===!0&&this.updateWorldTransform(),this.transform},a.prototype.draw=function(a,b){var c;if(this.material&&this.loaded)return this.material.use(),this.update(),null==b&&(b=this.transform),mat3.normalFromMat4(this.normalMatrix,b),c=mat4.clone(a.getProjectionMatrix()),mat4.multiply(c,c,a.getViewMatrix()),mat4.multiply(c,c,b),this.setMatrixUniforms(c,this.normalMatrix),this.bindTextures(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.vertexIndexBuffer.get()),gl.drawElements(gl.TRIANGLES,this.vertexIndexBuffer.numItems,gl.UNSIGNED_SHORT,0)},a.prototype.bindTextures=function(){return gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.material.diffuseMap),gl.uniform1i(this.material.getUniform("diffuseTex"),0),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,this.material.normalMap),gl.uniform1i(this.material.getUniform("normalTex"),1)},a.prototype.setMatrixUniforms=function(a,b){return this.material?(gl.uniformMatrix4fv(this.material.getUniform("uWorldViewProjectionMatrix"),!1,a),gl.uniformMatrix3fv(this.material.getUniform("uNormalMatrix"),!1,b),this.setFloatUniform("farClip",camera.far)):null},a.prototype.updateWorldTransform=function(a){null==a&&(a=null),mat4.identity(this.transform),mat4.translate(this.transform,this.transform,this.position),mat4.scale(this.transform,this.transform,this.scale),this.transformDirty=!1},a.prototype.setPosition=function(a){return vec3.copy(this.position,a),this.transformDirty=!0},a.prototype.setScale=function(a){return vec3.copy(this.scale,a),this.transformDirty=!0},a.prototype.translate=function(a){return vec3.translate(this.position,a),this.transformDirty=!0},a.prototype.rotateX=function(a){return quat.rotateX(this.rotation,this.rotation,a),this.transformDirty=!0},a.prototype.rotateY=function(a){return quat.rotateY(this.rotation,this.rotation,a),this.transformDirty=!0},a.prototype.rotateZ=function(a){return quat.rotateZ(this.rotation,this.rotation,a),this.transformDirty=!0},a.prototype.visit=function(a){var b,c,d,e,f;if(this.visible){for(a(this),e=this.children,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(b.visit(a));return f}},a.prototype.update=function(){return this.transformDirty?(mat4.fromRotationTranslationScale(this.transform,this.rotation,this.position,this.scale),this.transformDirty=!1):void 0},a.prototype.addChild=function(a){return this.children.push(a)},a.prototype.removeChild=function(a){return this.children.remove(a)},a}(),a.Scene=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return z(b,a),b}(a.Object3D),a.Mesh=function(b){function c(b,d){this.geometry=b,this.shader=d,c.__super__.constructor.call(this),null==this.geometry&&(this.geometry=new a.Geometry),null==this.shader&&(this.shader=new a.BasicShader)}return z(c,b),c}(a.Object3D),u=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(m={},k=[],c=[],h=4,g=Math.pow(10,h),j=[],d=e=0,i=a.length;i>e;d=e+=1)l=a[d],f=Math.round(l[0]*g)+"_"+Math.round(l[1]*g)+"_"+Math.round(l[2]*g),null!=m[f]?j.push(c[d]=c[m[f]]):(m[f]=d,k.push(a[d]),j.push(c[d]=k.length-1));return j},a.Face=function(){function a(a,b,c){this.a=a,this.b=b,this.c=c}return a}(),a.Geometry=function(){function a(){this.indices=[],this.faces=[],this.vertices=[],this.normals=[],this.texCoords=[[]],this.vertexBuffer=null,this.texCoordBuffers=[],this.indexBuffer=null,this.normalBuffer=null}return a}(),a.Geometry.meshCache={},a.Plane=function(a){function b(a,b){var c;null==b&&(b=1),c=a/2,this.vertices=[-c,0,0,c,0,0,c,0,c,-c,0,c],this.indexes=[]}return z(b,a),b}(a.Geometry),a.CubeGeometry=function(a){function b(a,c){null==c&&(c=1),b.__super__.constructor.call(this)}return z(b,a),b}(a.Geometry),a.SphereGeometry=function(a){function b(a){b.__super__.constructor.call(this)}return z(b,a),b}(a.Geometry),q=function(b,c){var d,e;return d=md5(b),console.log(d),null!=a.Geometry.meshCache[d]?(console.log("Not loading #{url}"),void c(a.Geometry.meshCache[d])):(e=new XMLHttpRequest,e.open("GET",b),e.onreadystatechange=function(){var b;return 4===e.readyState?(b=JSON.parse(e.responseText),a.Geometry.meshCache[d]=b,c(JSON.parse(e.responseText))):void 0},e.send())},a.JSONGeometry=function(b){function c(a){this.onDataLoaded=B(this.onDataLoaded,this),c.__super__.constructor.call(this),q(a,this.onDataLoaded),this.material=null,this.loaded=!1}return z(c,b),c.prototype.setMaterial=function(a){return this.material=a},c.prototype.bind=function(){var a,b,c;return this.material&&this.loaded&&this.material.diffuseMapLoaded&&this.material.normalMapLoaded?(this.material.use(),b=this.material.getAttribute("aVertexPosition"),c=this.material.getAttribute("aVertexTextureCoords"),a=this.material.getAttribute("aVertexNormal"),gl.enableVertexAttribArray(b),gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexPositionBuffer.get()),gl.vertexAttribPointer(b,this.vertexPositionBuffer.itemSize,gl.FLOAT,!1,12,0),gl.enableVertexAttribArray(c),gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexTextureCoordBuffer.get()),gl.vertexAttribPointer(c,this.vertexTextureCoordBuffer.itemSize,gl.FLOAT,!1,8,0),gl.enableVertexAttribArray(a),gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexNormalBuffer.get()),gl.vertexAttribPointer(a,this.vertexNormalBuffer.itemSize,gl.FLOAT,!1,12,0),!0):!1},c.prototype.release=function(){return gl.bindBuffer(gl.ARRAY_BUFFER,null)},c.prototype.setFloatUniform=function(a,b){return gl.uniform1f(this.material.getUniform(a),b)},c.prototype.setVec4Uniform=function(a,b,c,d,e){return gl.uniform4f(this.material.getUniform(a),b,c,d,e)},c.prototype.onDataLoaded=function(b){return this.vertexPositionBuffer=new a.Buffer(new Float32Array(b.vertexPositions),3,gl.STATIC_DRAW),this.vertexTextureCoordBuffer=new a.Buffer(new Float32Array(b.vertexTextureCoords),2,gl.STATIC_DRAW),this.vertexNormalBuffer=new a.Buffer(new Float32Array(b.vertexNormals),3,gl.STATIC_DRAW),this.vertexIndexBuffer=new a.Buffer(new Uint16Array(b.indices),1,gl.STATIC_DRAW,gl.ELEMENT_ARRAY_BUFFER),this.loaded=!0},c.load=function(b){return new a.JSONGeometry(b)},c}(a.Object3D),m=function(a){var b,c,d,e;if(d=document.getElementById(a),!d)return null;for(e="",b=d.firstChild;b;)3===b.nodeType&&(e+=b.textContent),b=b.nextSibling;if(c=null,"x-shader/x-fragment"===d.type)c=gl.createShader(gl.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!==d.type)return null;c=gl.createShader(gl.VERTEX_SHADER)}return gl.shaderSource(c,e),gl.compileShader(c),console.log(a,gl.getShaderInfoLog(c)),gl.getShaderParameter(c,gl.COMPILE_STATUS)?c:(console.log(a,gl.getShaderInfoLog(c)),null)},a.Uniform=function(){function a(a,b){this.name=a,this.shaderProgram=b,this.location=gl.getUniformLocation(this.shaderProgram,this.name)}return a.prototype.setValue=function(a){},a}(),a.UniformMat4=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return z(b,a),b.prototype.setValue=function(a){return gl.uniformMatrix4fv(this.location,!1,a)},b}(a.Uniform),a.UniformFloat=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return z(b,a),b.prototype.setValue=function(a){return gl.uniform1f(this.location,a)},b}(a.Uniform),a.UniformMat3=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return z(b,a),b.prototype.setValue=function(a){return gl.uniformMatrix3fv(this.location,!1,a)},b}(a.Uniform),a.UniformVec3=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return z(b,a),b.prototype.setValue=function(a){return gl.uniform3fv(this.location,3,a)},b}(a.Uniform),a.ShaderSource=function(){function a(a,b){this.vertexSource=a,this.fragmentSource=b}return a}(),a.ShaderLoader=function(){function b(b,c,d){this.vertUrl=b,this.fragUrl=c,this.callback=d,this.onVertexLoaded=B(this.onVertexLoaded,this),this.onFragmentLoaded=B(this.onFragmentLoaded,this),this.fragmentLoaded=!1,this.vertexLoaded=!1,this.result=new a.ShaderSource,s(this.vertUrl,this.onVertexLoaded),s(this.fragUrl,this.onFragmentLoaded)}return b.prototype.checkLoaded=function(){var a;return a=this.fragmentLoaded&&this.vertexLoaded,this.fragmentLoaded&&this.vertexLoaded},b.prototype.buildShader=function(){return h(this.result.vertexSource,this.result.fragmentSource)},b.prototype.onFragmentLoaded=function(a){var b,c;return b=gl.createShader(gl.FRAGMENT_SHADER),gl.shaderSource(b,a),gl.compileShader(b),(c=gl.getShaderInfoLog(b))&&console.log(c),this.result.fragmentSource=b,this.fragmentLoaded=!0,this.checkLoaded()?this.callback(this.buildShader()):void 0},b.prototype.onVertexLoaded=function(a){var b,c;return c=gl.createShader(gl.VERTEX_SHADER),gl.shaderSource(c,a),gl.compileShader(c),(b=gl.getShaderInfoLog(c))&&console.log(b),this.result.vertexSource=c,this.vertexLoaded=!0,this.checkLoaded()?this.callback(this.buildShader()):void 0},b.load=function(a,c,d){return new b(a,c,d)},b}(),r=function(a,b){},s=function(a,b){var c;return c=new XMLHttpRequest,c.open("GET",a),c.onreadystatechange=function(){return 4===c.readyState?b(c.responseText):void 0},c.send()},h=function(a,b){var c,d;return d=gl.createProgram(),gl.attachShader(d,a),gl.attachShader(d,b),gl.linkProgram(d),(c=gl.getProgramInfoLog(d))&&console.log(c),d},f=function(a,b){var c,d;return c=m(b),d=m(a),g(d,c)},g=function(a,b){var c;return c=gl.createProgram(),gl.attachShader(c,a),gl.attachShader(c,b),gl.linkProgram(c),console.log(gl.getProgramInfoLog(c)),c},x={35664:"FLOAT_VEC2",35665:"FLOAT_VEC3",35666:"FLOAT_VEC4",35667:"INT_VEC2",35668:"INT_VEC3",35669:"INT_VEC4",35670:"BOOL",35671:"BOOL_VEC2",35672:"BOOL_VEC3",35673:"BOOL_VEC4",35674:"FLOAT_MAT2",35675:"FLOAT_MAT3",35676:"FLOAT_MAT4",35678:"SAMPLER_2D",35680:"SAMPLER_CUBE",5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5124:"INT",5125:"UNSIGNED_INT",5126:"FLOAT"},n=function(a){var b,c,d,e,f,g,h,i,j,k;for(gl.useProgram(a),j={attributes:[],uniforms:[],attributeCount:0,uniformCount:0},c=gl.getProgramParameter(a,gl.ACTIVE_UNIFORMS),b=gl.getProgramParameter(a,gl.ACTIVE_ATTRIBUTES),e=f=0,h=c;h>=0?h>f:f>h;e=h>=0?++f:--f)k=gl.getActiveUniform(a,e),k.typeName=x[k.type],j.uniforms.push(k),j.uniformCount+=k.size;for(e=g=0,i=b;i>=0?i>g:g>i;e=i>=0?++g:--g)d=gl.getActiveAttrib(a,e),d.typeName=x[d.type],j.attributes.push(d),j.attributeCount+=d.size;return j},t=function(a,b){var c;return c=gl.createTexture(),c.image=new Image,c.image.onload=function(){return gl.bindTexture(gl.TEXTURE_2D,c),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c.image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null),b(c)},c.image.src=a},a.TextureMapTypes=function(){function a(){}return a.DIFFUSE=1,a.NORMAL=2,a.SPECULAR=3,a.CUBE=4,a.SPHERE=5,a}(),a.Shader=function(){function a(a){this.program=a,this.params=n(this.program),this.diffuseMapLoaded=this.normalMapLoaded=!1,this.buildUniforms(),this.buildAttributes()}return a.prototype.buildUniforms=function(){var a,b,c,d,e;for(this.uniforms={},c=this.params.uniforms,d=[],a=0,b=c.length;b>a;a++)e=c[a],d.push(this.uniforms[e.name]=gl.getUniformLocation(this.program,e.name));return d},a.prototype.buildAttributes=function(){var a,b,c,d,e;for(this.attributes={},d=this.params.attributes,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.attributes[a.name]=gl.getAttribLocation(this.program,a.name));return e},a.prototype.use=function(){return gl.useProgram(this.program)},a.prototype.showInfo=function(){return console.log(this.program),console.table(this.params.uniforms),console.table(this.params.attributes)},a.prototype.setDiffuseMap=function(a){return t(a,function(a){return function(b){return a.diffuseMap=b,a.diffuseMapLoaded=!0}}(this))},a.prototype.setNormalMap=function(a){return t(a,function(a){return function(b){return a.normalMap=b,a.normalMapLoaded=!0}}(this))},a.prototype.getUniform=function(a){return this.uniforms[a]},a.prototype.getAttribute=function(a){return this.attributes[a]},a}(),q=function(b,c){var d,e;return d=md5(b),console.log(d),null!=a.Geometry.meshCache[d]?(console.log("Not loading #{url}"),void c(a.Geometry.meshCache[d])):(e=new XMLHttpRequest,e.open("GET",b),e.onreadystatechange=function(){var b;return 4===e.readyState?(b=JSON.parse(e.responseText),a.Geometry.meshCache[d]=b,c(JSON.parse(e.responseText))):void 0},e.send())},a.Resource=function(){function b(b){this.url=null!=b?b:null,this.id=a.nextId()}return b.prototype.load=function(){},b.prototype.unload=function(){},b.prototype.bind=function(){},b}(),a.ModelResource=function(b){function c(a){this.url=a,this.onDataLoaded=B(this.onDataLoaded,this),c.__super__.constructor.call(this),q(this.url,this.onDataLoaded)}return z(c,b),c.prototype.setMaterial=function(a){return this.material=a},c.prototype.onDataLoaded=function(b){return this.vertexPositionBuffer=new a.Buffer(new Float32Array(b.vertexPositions),3,gl.STATIC_DRAW),this.vertexTextureCoordBuffer=new a.Buffer(new Float32Array(b.vertexTextureCoords),2,gl.STATIC_DRAW),this.vertexNormalBuffer=new a.Buffer(new Float32Array(b.vertexNormals),3,gl.STATIC_DRAW),this.vertexIndexBuffer=new a.Buffer(new Uint16Array(b.indices),1,gl.STATIC_DRAW,gl.ELEMENT_ARRAY_BUFFER),this.loaded=!0},c.prototype.ready=function(){return this.ready||(this.ready=null!=(this.loaded&&this.material&&this.material.ready))},c.prototype.bind=function(){var a,b,c;return this.ready()?(this.material.use(),b=this.material.getAttribute("aVertexPosition"),c=this.material.getAttribute("aVertexTextureCoords"),a=this.material.getAttribute("aVertexNormal"),gl.enableVertexAttribArray(b),gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexPositionBuffer.get()),gl.vertexAttribPointer(b,this.vertexPositionBuffer.itemSize,gl.FLOAT,!1,12,0),gl.enableVertexAttribArray(c),gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexTextureCoordBuffer.get()),gl.vertexAttribPointer(c,this.vertexTextureCoordBuffer.itemSize,gl.FLOAT,!1,8,0),gl.enableVertexAttribArray(a),gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexNormalBuffer.get()),gl.vertexAttribPointer(a,this.vertexNormalBuffer.itemSize,gl.FLOAT,!1,12,0),!0):!1},c}(a.Resource),c=function(){function a(a,b,c){this.value=a,this.dt=c,this.damping=Math.pow(b,this.dt),this.last=this.value,this.display=this.value,this.velocity=0}return a.prototype.accelerate=function(a){return this.velocity+=a*this.dt},a.prototype.integrate=function(){return this.velocity*=this.damping,this.last=this.value,this.value+=this.velocity*this.dt},a.prototype.interpolate=function(a){return this.display=this.last*a+(1-a)*this.value},a.prototype.get=function(){return this.display},a.prototype.set=function(a){return this.value=a,this.last=this.value},a}(),d=function(){function a(a,b,d,e,f){this.x=new c(a,e,f),this.y=new c(b,e,f),this.z=new c(d,e,f)}return a.prototype.accelerate=function(a,b,c){return this.x.accelerate(a),this.y.accelerate(b),this.z.accelerate(c)},a.prototype.integrate=function(){return this.x.integrate(),this.y.integrate(),this.z.integrate()},a.prototype.interpolate=function(a){return this.x.interpolate(a),this.y.interpolate(a),this.z.interpolate(a)},a.prototype.set=function(a,b,c){return a instanceof Array?(this.x.set(a[0]),this.y.set(a[1]),this.z.set(a[2])):(this.x.set(a),this.y.set(b),this.z.set(c))},a}(),a.Camera=function(a){function b(a,c){this.viewportWidth=a,this.viewportHeight=c,b.__super__.constructor.call(this),null==this.viewportWidth&&(this.viewportWidth=gl.viewportWidth),null==this.viewportHeight&&(this.viewportHeight=gl.viewportHeight),this.target=vec3.create(),this.fov=45,this.up=vec3.fromValues(0,1,0),this.viewMatrix=mat4.create(),this.near=.01,this.far=60,this.projectionMatrix=mat4.create(),this.updateProjectionMatrix(),this.updateViewMatrix()}return z(b,a),b.prototype.setFarClip=function(a){return this.far=a,this.updateProjectionMatrix()},b.prototype.setNearClip=function(a){return this.near=a,this.updateProjectionMatrix()},b.prototype.getViewMatrix=function(){return this.viewMatrix},b.prototype.getProjectionMatrix=function(){return this.projectionMatrix},b.prototype.getFrustumCorners=function(){var a,b,c,d,e,f,g,h,i,j;return i=vec3.create(),vec3.sub(i,this.target,this.position),vec3.normalize(i,i),j=vec3.create(),vec3.cross(j,viewVector,this.up),h=this.fov*Math.PI/180,g=this.viewportWidth/this.viewportHeight,d=2*Math.tan(h/2)*this.near,f=d*g,c=2*Math.tan(h/2)*this.far,e=c*g,b=vec3.create(),a=vec3.create(),vec3.add(b,this.position,i),vec3.scale(b,b,this.near),vec3.add(a,this.position,i),vec3.scale(a,a,this.far)},b.prototype.getInverseProjectionMatrix=function(){var a;return a=mat4.create(),mat4.invert(a,this.projectionMatrix),a},b.prototype.updateViewMatrix=function(){return mat4.identity(this.viewMatrix),mat4.lookAt(this.viewMatrix,this.position,this.target,this.up)},b.prototype.updateProjectionMatrix=function(){var a;return mat4.identity(this.projectionMatrix),a=this.viewportWidth/this.viewportHeight,mat4.perspective(this.projectionMatrix,this.fov,a,this.near,this.far)},b}(a.Object3D),e=function(){function a(a,b){this.element=a,this.mouseMove=B(this.mouseMove,this),this.mouseUp=B(this.mouseUp,this),this.mouseDown=B(this.mouseDown,this),this.onMove=null!=b?b:function(){return null},this.pressed=!1,this.x=null,this.y=null,this.element.addEventListener("mousedown",this.mouseDown),this.element.addEventListener("mouseup",this.mouseUp),this.element.addEventListener("mousemove",this.mouseMove)}return a.prototype.mouseDown=function(a){return this.pressed=!0},a.prototype.mouseUp=function(a){return this.pressed=!1},a.prototype.mouseMove=function(a){var b,c,d,e,f;return d=this.element.getBoundingClientRect(),e=a.clientX-d.left,f=a.clientY-d.top,null!=this.x?(b=this.x-e,c=this.y-f):(b=0,c=0),this.x=e,this.y=f,this.onMove(this.x,this.y,b,c)},a}(),o={87:"w",65:"a",83:"s",68:"d",81:"q",69:"e",37:"left",39:"right",38:"up",40:"down",13:"enter",27:"esc",32:"space",8:"backspace",16:"shift",17:"ctrl",18:"alt",91:"start",0:"altc",20:"caps",9:"tab",49:"key1",50:"key2",51:"key3",52:"key4"},p={};for(y in o)v=o[y],p[v]=!1;document.addEventListener("keydown",function(a){return v=o[a.keyCode],p[v]=!0}),document.addEventListener("keyup",function(a){return v=o[a.keyCode],p[v]=!1}),a.FPSCamera=function(a){function b(a,c,f){this.viewportWidth=a,this.viewportHeight=c,this.canvas=f,this.pointerMove=B(this.pointerMove,this),b.__super__.constructor.call(this),this.origin=vec3.create(),this.rotation=0,this.pitch=0,this.rotVec=vec3.create(),this.pointer=new e(this.canvas,this.pointerMove),this.dt=1/24,this.position=new d(0,0,0,.05,this.dt),this.time=performance.now()/1e3}return z(b,a),b.prototype.setPosition=function(a){return this.position.set(a[0],a[1],a[2])},b.prototype.pointerMove=function(a,b,c,d){return this.pointer.pressed?(this.rotation-=.01*c,this.pitch-=.01*d):void 0},b.prototype.step=function(){var a,b;for(b=performance.now()/1e3;this.time<b;)this.time+=this.dt,this.position.integrate();return a=(this.time-b)/this.dt,this.position.interpolate(a)},b.prototype.cameraAcceleration=function(){var a;return a=100,vec3.set(this.rotVec,a,0,0),vec3.rotateY(this.rotVec,this.rotVec,this.rotVec,-this.rotation),p.a&&this.position.accelerate(-this.rotVec[0],-this.rotVec[1],-this.rotVec[2]),p.d&&this.position.accelerate(this.rotVec[0],this.rotVec[1],this.rotVec[2]),vec3.set(this.rotVec,0,0,a),vec3.rotateY(this.rotVec,this.rotVec,this.rotVec,-this.rotation),p.w&&this.position.accelerate(-this.rotVec[0],-this.rotVec[1],-this.rotVec[2]),p.s?this.position.accelerate(this.rotVec[0],this.rotVec[1],this.rotVec[2]):void 0},b.prototype.update=function(){return this.cameraAcceleration(),this.step()},b.prototype.updateViewMatrix=function(){var a;return mat4.identity(this.viewMatrix),mat4.rotateX(this.viewMatrix,this.viewMatrix,this.pitch),mat4.rotateY(this.viewMatrix,this.viewMatrix,this.rotation),this.position.x?(a=vec3.fromValues(this.position.x.display,this.position.y.display,this.position.z.display),mat4.translate(this.viewMatrix,this.viewMatrix,a)):void 0},b}(a.Camera),a.DirectionalLight=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return z(b,a),b.prototype.bind=function(a){return gl.uniform3fv(a.lightColor,this.color),gl.uniform3fv(a.lightDirection,this.direction)},b}(a.Object3D),a.ShadowCamera=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return z(b,a),b}(a.Camera),a.Gbuffer=function(){function a(a){this.resolution=null!=a?a:1,this.width=gl.viewportWidth/this.resolution,this.height=gl.viewportHeight/this.resolution,this.createFrameBuffer()}return a.prototype.createFrameBuffer=function(){var a;return this.mrt_ext=gl.getExtension("WEBGL_draw_buffers"),this.half_ext=gl.getExtension("OES_texture_half_float"),this.depth_ext=gl.getExtension("WEBKIT_WEBGL_depth_texture")||gl.getExtension("WEBGL_depth_texture"),this.frameBuffer=gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer),this.albedoTextureUnit=this.createTexture(),this.normalsTextureUnit=this.createTexture(this.half_ext.HALF_FLOAT_OES),this.depthComponent=this.createDepthTexture(),gl.framebufferTexture2D(gl.FRAMEBUFFER,this.mrt_ext.COLOR_ATTACHMENT0_WEBGL,gl.TEXTURE_2D,this.albedoTextureUnit,0),gl.framebufferTexture2D(gl.FRAMEBUFFER,this.mrt_ext.COLOR_ATTACHMENT1_WEBGL,gl.TEXTURE_2D,this.normalsTextureUnit,0),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,this.depthComponent,0),a=gl.checkFramebufferStatus(gl.FRAMEBUFFER),console.log("GBuffer FrameBuffer status after initialization: "+a),this.mrt_ext.drawBuffersWEBGL([this.mrt_ext.COLOR_ATTACHMENT0_WEBGL,this.mrt_ext.COLOR_ATTACHMENT1_WEBGL]),this.release()},a.prototype.createDepthTexture=function(){var a;return a=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.DEPTH_COMPONENT,this.width,this.height,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_SHORT,null),a},a.prototype.createTexture=function(a){var b;return a=this.half_ext.HALF_FLOAT_OES,b=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,b),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,a,null),b},a.prototype.bind=function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer)},a.prototype.release=function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)},a.prototype.getDepthTextureUnit=function(){return this.depthComponent},a.prototype.getAlbedoTextureUnit=function(){return this.albedoTextureUnit},a.prototype.getNormalsTextureUnit=function(){return this.normalsTextureUnit},a}(),l="attribute vec3 aVertexPosition;\nattribute vec2 aVertexTextureCoords;\n\nvarying vec2 vTexCoords;\n\nvoid main( void ) {\n  // passthru\n  gl_Position = vec4(aVertexPosition, 1.0);\n  \n  vTexCoords = aVertexTextureCoords;\n}\n",k="varying vec2 vTexCoords;\n\nvoid main (void) {\n  gl_FragColor = vec4(vTexCoords, 1.0, 1.0);\n}\n",a.DebugGridView=function(){function b(a){this.build_geometry(a)}return b.prototype.build_geometry=function(b){var c,d,e,f,g,h,i,j,k,l,m;for(l=-1,m=-1,e=2/b,k=.5,this.vertices=[],this.textureCoords=[],this.indices=[],d=0,c=g=1,h=b;h>=1?h>=g:g>=h;c=h>=1?++g:--g)j=[l,m,c,l+e,m,c,l+e,m+e,c,l,m+e,c],i=[0,0,1,0,1,1,0,1],f=[d,d+1,d+2,d+2,d+3,d],d+=4,l+=e,this.vertices=this.vertices.concat(j),this.textureCoords=this.textureCoords.concat(i),this.indices=this.indices.concat(f);return this.vertexBuffer=new a.Buffer(new Float32Array(this.vertices),3,gl.STATIC_DRAW),this.textureBuffer=new a.Buffer(new Float32Array(this.textureCoords),2,gl.STATIC_DRAW),this.indexBuffer=new a.Buffer(new Uint16Array(this.indices),1,gl.STATIC_DRAW,gl.ELEMENT_ARRAY_BUFFER)},b.prototype.bind=function(a){return gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer.get()),gl.enableVertexAttribArray(a.getAttribute("aVertexPosition")),gl.vertexAttribPointer(a.getAttribute("aVertexPosition"),3,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,this.textureBuffer.get()),gl.enableVertexAttribArray(a.getAttribute("aVertexTextureCoords")),gl.vertexAttribPointer(a.getAttribute("aVertexTextureCoords"),2,gl.FLOAT,!1,0,0)},b.prototype.draw=function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer.get()),gl.drawElements(gl.TRIANGLES,this.indexBuffer.numItems,gl.UNSIGNED_SHORT,0)},b.prototype.release=function(){return gl.bindBuffer(gl.ARRAY_BUFFER,null)},b}(),a.FullscreenQuad=function(b){function c(){c.__super__.constructor.call(this),this.vertices=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1],this.textureCoords=[0,0,1,0,0,1,0,1,1,0,1,1],this.vertexBuffer=new a.Buffer(new Float32Array(this.vertices),2,gl.STATIC_DRAW),this.textureBuffer=new a.Buffer(new Float32Array(this.textureCoords),2,gl.STATIC_DRAW)}return z(c,b),c.prototype.setMaterial=function(a){return this.material=a},c.prototype.bind=function(){return gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer.get()),gl.enableVertexAttribArray(this.material.getAttribute("aVertexPosition")),gl.vertexAttribPointer(this.material.getAttribute("aVertexPosition"),2,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,this.textureBuffer.get()),gl.enableVertexAttribArray(this.material.getAttribute("aVertexTextureCoords")),gl.vertexAttribPointer(this.material.getAttribute("aVertexTextureCoords"),2,gl.FLOAT,!1,0,0)},c.prototype.release=function(){return gl.bindBuffer(gl.ARRAY_BUFFER,null)},c}(a.Object3D),b=function(){function b(a,b){this.gbuffer=a,null==b&&(b=6),this.depthTex=this.gbuffer.getDepthTextureUnit(),this.normalsTex=this.guffer.getNormalsTexture(),this.albedoTex=this.gbuffer.getAlbedoTextureUnit(),this.createMaterial(),this.createQuads(b)}return b.prototype.draw=function(a){var b,c,d,e;for(this.material.use(),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.gbuffer.getDepthTextureUnit()),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,this.gbuffer.getNormalsTextureUnit()),gl.activeTexture(gl.TEXTURE2),gl.bindTexture(gl.TEXTURE_2D,this.gbuffer.getAlbedoTextureUnit()),gl.uniform1i(this.material.getUniform("depthTexture"),0),gl.uniform1i(this.material.getUniform("normalsTexture"),1),gl.uniform1i(this.material.getUniform("albedoTexture"),2),gl.uniformMatrix4fv(this.material.getUniform("inverseProjectionMatrix"),!1,a.getInverseProjectionMatrix()),e=[],b=c=0,d=this.quads.length;d>=0?d>=c:c>=d;b=d>=0?++c:--c)e.push(this.drawQuad(b));return e},b.prototype.drawQuad=function(a){return this.quads[i].bind(),gl.uniform1i(this.material.getUniform("DEBUG"),a),gl.drawArrays(gl.TRIANGLES,0,this.quads[i].vertexBuffer.numItems),this.quads[i].release()},b.prototype.createMaterial=function(){return this.material=new a.Shader("fs_quad_vert","fs_quad_frag"),this.debug_uniform_location=this.material.getUniform("DEBUG")},b.prototype.createQuads=function(a){var b,c,d,e,f;return d=Math.ceil(Math.sqrt(a)),c=gl.viewportWidth/d,b=gl.viewportHeight/d,e=0,f=0,this.quads=[]},b.prototype.createQuad=function(a,b,c,d){},b}(),a.Transform=function(){function a(){this._translation=vec3.create(),this._scale=vec3.fromValues(1,1,1),this._rotation=quat.create()}return a.prototype.translate=function(a){return vec3.add(this._translation,this._translation,a)},a.prototype.scale=function(a){return vec3.scale(this._scale,this._scale,a)},a.prototype.scaleVector=function(a){return vec3.multiply(this._scale,this._scale,a)},a.prototype.rotateX=function(a){return quat.rotateX(this._rotation,this._rotation,a)},a.prototype.rotateY=function(a){return quat.rotateY(this._rotation,this._rotation,a)},a.prototype.rotateZ=function(a){return quat.rotateZ(this._rotation,this._rotation,a)},a.prototype.getMatrix=function(a){return null==a&&(a=mat4.create()),mat4.fromRotationTranslationScale(a,this._rotation,this._translation,this._scale)},a}(),a.SceneNode=function(){function b(b,c){this.transform=b,this.object=null!=c?c:null,this.localMatrix=mat4.create(),this.worldMatrix=mat4.create(),this.children=[],this.parent=null,this.visible=!0,null==this.transform&&(this.transform=new a.Transform)}return b.prototype.translate=function(a){return this.transform.translate(a)},b.prototype.scale=function(a){return this.transform.scale(a)},b.prototype.scaleVector=function(a){return this.transform.scaleVector(a)},b.prototype.rotateX=function(a){return this.transform.rotateX(a)},b.prototype.rotateY=function(a){return this.transform.rotateY(a)},b.prototype.rotateZ=function(a){return this.transform.rotateZ(a)},b.prototype.walk=function(a){var b,c,d,e,f;if(this.visible){for(a(this),e=this.children,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(a(b));return f}},b.prototype.addChild=function(a){return a.setParent(this)},b.prototype.setParent=function(a){return null!=a?(this.parent&&C.call(this.parent.children,this)>=0&&(this.parent.children=this.parent.chilren.filter(function(a){return a!==this})),null!=a.children&&a.children.push(this),this.parent=a):void 0},b.prototype.updateWorldMatrix=function(a){var b,c,d,e,f;for(mat4.copy(this.localMatrix,this.transform.getMatrix()),a?mat4.multiply(this.worldMatrix,a,this.localMatrix):mat4.copy(this.worldMatrix,this.localMatrix),e=this.children,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(b.updateWorldMatrix(this.worldMatrix));return f},b.prototype.attach=function(a){this.object=a},b}(),a.Scene=function(){function b(){this.root=new a.SceneNode}return b}(),a.Renderer=function(){function b(b){this.ready=!1,
this.debug_view=0,this.width=b?b.width:1280,this.height=b?b.height:720,this.sunPosition=vec3.fromValues(30,60,-20),null==b&&(b=document.createElement("canvas"),document.body.appendChild(b)),b.width=this.width,b.height=this.height,a.gl=window.gl=b.getContext("webgl"),gl.viewportWidth=b.width,gl.viewportHeight=b.height,this.canvas=b,this.gbuffer=new a.Gbuffer(1),this.createTargets(),this.setDefaults()}return b.prototype.createTargets=function(){return a.ShaderLoader.load("shaders/fs_quad_vert.glsl","shaders/fs_quad_frag.glsl",function(b){return function(c){return b.quad=new a.FullscreenQuad,b.quad.setMaterial(new a.Shader(c)),b.quad.material.showInfo(),b.ready=!0}}(this))},b.prototype.setDefaults=function(){return gl.clearColor(0,0,0,0),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),gl.depthMask(!0),gl.clearDepth(1),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.enable(gl.CULL_FACE)},b.prototype.enableGBuffer=function(){return this.gbuffer.bind(),gl.cullFace(gl.BACK),gl.blendFunc(gl.ONE,gl.ZERO),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.enable(gl.CULL_FACE)},b.prototype.updateGBuffer=function(a,b){return this.enableGBuffer(),b.updateViewMatrix(),b.updateProjectionMatrix(),a.root.updateWorldMatrix(),a.root.walk(function(a){return null!=a.object&&a.object.bind()?(a.object.draw(b,a.worldMatrix),a.object.release()):void 0}),this.gbuffer.release()},b.prototype.doLighting=function(a,b){return this.quad.material.use(),this.quad.bind(),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.gbuffer.getDepthTextureUnit()),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,this.gbuffer.getNormalsTextureUnit()),gl.activeTexture(gl.TEXTURE2),gl.bindTexture(gl.TEXTURE_2D,this.gbuffer.getAlbedoTextureUnit()),gl.uniform1i(this.quad.material.getUniform("depthTexture"),0),gl.uniform1i(this.quad.material.getUniform("normalsTexture"),1),gl.uniform1i(this.quad.material.getUniform("albedoTexture"),2),gl.uniform3fv(this.quad.material.getUniform("lightPosition"),this.sunPosition),gl.uniformMatrix4fv(this.quad.material.getUniform("inverseProjectionMatrix"),!1,b.getInverseProjectionMatrix()),gl.uniform1i(this.quad.material.getUniform("DEBUG"),this.debug_view),gl.drawArrays(gl.TRIANGLES,0,this.quad.vertexBuffer.numItems),this.quad.release()},b.prototype.draw=function(a,b){return this.ready?(this.updateGBuffer(a,b),this.doLighting(a,b)):void 0},b}()}).call(this);